name: E2E Asset Execution Test ðŸ§ª

on:
  workflow_dispatch: ~
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  merge_group:

jobs:
  e2e_asset_execution_test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - uses: actions/checkout@v5
    - name: âš¡ Setup Golang
      uses: actions/setup-go@v6
      with:
        go-version-file: go.mod
        cache: true

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: '1.81.0'
        components: rustfmt, clippy

    - name: âš¡ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: tavern/internal/www/package-lock.json

    - name: ðŸ“¦ Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler libssl-dev

    - name: ðŸ”¨ Build Frontend
      working-directory: tavern/internal/www
      run: |
        npm ci
        npm run build

    - name: ðŸ”¨ Build Tavern
      run: |
        go mod download
        go build -v -o tavern_bin ./tavern
    - name: ðŸš€ Run Tavern
      env:
        HTTP_LISTEN_ADDR: ":8000"
      run: |
        ./tavern_bin > tavern.log 2>&1 &
        echo "Waiting for Tavern to start..."
        # Wait for port 8000
        timeout 30 sh -c 'until nc -z $0 $1; do sleep 1; done' localhost 8000
    - name: ðŸ¤– Run Agent
      working-directory: implants/imix
      env:
        IMIX_CALLBACK_URI: "http://localhost:8000"
        IMIX_CALLBACK_INTERVAL: 1
      run: |
        # Fetch the pubkey and verify it's not empty
        PUBKEY=$(curl -s http://localhost:8000/status | jq -r .Pubkey)
        if [ -z "$PUBKEY" ] || [ "$PUBKEY" == "null" ]; then
          echo "Error: Could not fetch Pubkey from Tavern"
          exit 1
        fi
        export IMIX_SERVER_PUBKEY=$PUBKEY
        echo "Got pubkey: $IMIX_SERVER_PUBKEY"

        echo "Building imix..."
        cargo build --bin imix --target-dir ./build
        # Run agent and pipe logs to a file
        ./build/debug/imix > agent.log 2>&1 &

        # Give the agent a moment to perform the initial handshake
        echo "Agent started. Waiting for initial callback..."
        sleep 5
    - name: ðŸŽ­ Install Playwright
      working-directory: tests/e2e
      run: |
        npm ci
        npx playwright install --with-deps chromium
    - name: ðŸ§ª Run E2E Tests
      working-directory: tests/e2e
      run: |
        npx playwright test tests/asset_execution.spec.ts
    - name: ðŸ“‚ Upload Service Logs
      if: always() # Runs even if tests fail
      uses: actions/upload-artifact@v4
      with:
        name: e2e-logs
        path: |
          tavern.log
          implants/imix/agent.log
