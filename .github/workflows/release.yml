name: Release

env:
  CARGO_TERM_COLOR: always
  IMIX_CALLBACK_URI: http://127.0.0.1

on:
  workflow_dispatch: ~
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
####################################################################################
###                                     IMIX                                     ###
####################################################################################

###
# WINDOWS
###
  upload_imix_windows:
    name: 🚀 [Windows] Imix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: 🛠️ Setup Rust Toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: '1.76.0'
          default: true
          profile: minimal
      - name: 🛠️ Setup Rust Toolchain (Loader)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly-2024-02-11
          default: false
          profile: minimal
      - name: ⚡ Setup Rust (x86_64-pc-windows-gnu)
        run: |
          sudo apt update && \
          sudo apt install -y gcc-mingw-w64 && \
          rustup target add x86_64-pc-windows-gnu --toolchain '1.76.0' && \
          rustup target add x86_64-pc-windows-gnu --toolchain 'nightly-2024-02-11'
      - name: 🔨 Build Loader
        working-directory: ./bin/reflective_loader/
        run: cargo build --release --target=x86_64-pc-windows-gnu -Z build-std=core,compiler_builtins -Z build-std-features=compiler-builtins-mem
      - name: 🔨 Build Imix
        run: cargo build --bin=imix --release --verbose --target=x86_64-pc-windows-gnu
        working-directory: ./implants/imix
        env:
          CARGO_TARGET_DIR: ${{ runner.temp }}/realm_build
          RUSTFLAGS: "-C target-feature=+crt-static"
      - name: 🔨 Build Imix (DLL)
        run: cargo build --lib --release
        working-directory: ./implants/imix
        env:
          CARGO_TARGET_DIR: ${{ runner.temp }}/realm_build
          RUSTFLAGS: "-C target-feature=+crt-static"

####################################################################################
###                                     GOLEM                                     ###
####################################################################################

###
# WINDOWS
###
  upload_golem_windows:
      name: 🚀 [Windows] Golem
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v3
        - name: 🛠️ Setup Rust Toolchain
          uses: actions-rs/toolchain@v1
          with:
            toolchain: '1.76.0'
            default: true
            profile: minimal
        - name: 🛠️ Setup Rust Toolchain (Loader)
          uses: actions-rs/toolchain@v1
          with:
            toolchain: nightly-2024-02-11
            default: false
            profile: minimal
        - name: ⚡ Setup Rust
          run: |
            sudo apt update && \
            sudo apt install -y gcc-mingw-w64 && \
            rustup target add x86_64-pc-windows-gnu --toolchain '1.76.0' && \
            rustup target add x86_64-pc-windows-gnu --toolchain 'nightly-2024-02-11'
        - name: 🔨 Build Loader
          working-directory: ./bin/reflective_loader/
          run: cargo build --release --target=x86_64-pc-windows-gnu -Z build-std=core,compiler_builtins -Z build-std-features=compiler-builtins-mem
        - name: 🔨 Build Golem
          run: cargo build --bin=golem --release --verbose --target=x86_64-pc-windows-gnu
          working-directory: ./implants/golem
          env:
            CARGO_TARGET_DIR: ${{ runner.temp }}/realm_build
            RUSTFLAGS: "-C target-feature=+crt-static"
