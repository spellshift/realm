name: Tests

on:
  workflow_dispatch: ~
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  merge_group:

env:
  CARGO_TERM_COLOR: always

jobs:
  tavern:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - name: âš¡ Setup Golang
      uses: actions/setup-go@v6
      with:
        go-version-file: go.mod
        cache: true
    - name: ðŸ”¨ Install Tools
      run: |
        # Pin gotestsum to v1.12.0 to support Go 1.23.4 (v1.13.0 requires Go 1.24)
        go install gotest.tools/gotestsum@v1.12.0
        go install github.com/ctrf-io/go-ctrf-json-reporter/cmd/go-ctrf-json-reporter@latest
    - name: ðŸ”¨ Build
      run: go build -v -o ./build/tavern ./tavern
    - name: ðŸ”Ž Test
      # Use gotestsum for human-readable output to stdout, and capture JSON to file for reporting
      shell: bash
      run: |
        $(go env GOPATH)/bin/gotestsum --jsonfile test-output.json -- \
          -v -race -coverprofile='coverage.out' -covermode=atomic ./tavern/...
    - name: ðŸ”„ Convert to CTRF
      if: always() # Run even if tests fail so we report the failures
      shell: bash
      run: |
        if [ -f test-output.json ]; then
          cat test-output.json | $(go env GOPATH)/bin/go-ctrf-json-reporter -o ctrf-tavern-${{ matrix.os }}.json
          # Normalize timestamps to avoid 50+ year durations when merging with reports lacking timestamps
          jq '.results.summary.stop = (.results.summary.stop - .results.summary.start) | .results.summary.start = 0' ctrf-tavern-${{ matrix.os }}.json > ctrf-tavern-${{ matrix.os }}.json.tmp && mv ctrf-tavern-${{ matrix.os }}.json.tmp ctrf-tavern-${{ matrix.os }}.json
        else
          echo "test-output.json not found, skipping CTRF conversion"
        fi
    - name: ðŸ“¶ Upload Coverage Results
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.out
        flags: tavern
        name: tavern-coverage
    - name: ðŸ“¤ Upload CTRF Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ctrf-tavern-${{ matrix.os }}
        path: ctrf-tavern-${{ matrix.os }}.json

  ####################################################################################
  ###                           IMPLANTS - LINUX                                  ###
  ####################################################################################
  implants-linux:
    name: Implants (Linux)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      IMIX_SERVER_PUBKEY: "pR56vDJZb9b3BL3ZvCXIvgK0r2vCk7FiZ1RjeEhJVyU="
    steps:
    - uses: actions/checkout@v5
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: '1.91.1'
        default: true
        profile: minimal
        components: rustfmt, clippy
    - name: rust-cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "./implants/ -> ../target"
    - name: Install latest nextest & cargo-llvm-cov release
      uses: taiki-e/install-action@v2
      with:
        tool: nextest,cargo-llvm-cov
    - name: ðŸ”Ž Run tests
      run: |
        cd ./implants/ &&
        cargo fmt --check &&
        cargo llvm-cov nextest --lcov --output-path lcov.info
    - name: ðŸ”„ Convert to CTRF
      if: always()
      shell: bash
      run: |
        cd ./implants/
        JUNIT_PATH=$(find . -name junit.xml | head -n 1)
        if [ -n "$JUNIT_PATH" ]; then
          mv "$JUNIT_PATH" junit-implants-ubuntu-latest.xml
        else
          echo "No JUnit report generated"
        fi
        if [ -f junit-implants-ubuntu-latest.xml ]; then
          npx junit-to-ctrf junit-implants-ubuntu-latest.xml -o ctrf-implants-ubuntu-latest.json
        fi
    - name: ðŸ“¶ Upload Coverage Results
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./implants/lcov.info
        flags: implants
        name: implants-coverage-ubuntu-latest
    - name: ðŸ“¤ Upload CTRF Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ctrf-implants-ubuntu-latest
        path: implants/ctrf-implants-ubuntu-latest.json

  ####################################################################################
  ###                           IMPLANTS - MACOS                                   ###
  ####################################################################################
  implants-macos:
    name: Implants (macOS)
    runs-on: macOS-latest
    timeout-minutes: 60
    env:
      IMIX_SERVER_PUBKEY: "pR56vDJZb9b3BL3ZvCXIvgK0r2vCk7FiZ1RjeEhJVyU="
    steps:
    - uses: actions/checkout@v5
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: '1.91.1'
        default: true
        profile: minimal
        components: rustfmt, clippy
    - name: rust-cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "./implants/ -> ../target"
    - name: Install latest nextest & cargo-llvm-cov release
      uses: taiki-e/install-action@v2
      with:
        tool: nextest,cargo-llvm-cov
    - name: ðŸ”Ž Run tests
      run: |
        cd ./implants/ &&
        cargo fmt --check &&
        cargo llvm-cov nextest --lcov --output-path lcov.info
    - name: ðŸ”„ Convert to CTRF
      if: always()
      shell: bash
      run: |
        cd ./implants/
        JUNIT_PATH=$(find . -name junit.xml | head -n 1)
        if [ -n "$JUNIT_PATH" ]; then
          mv "$JUNIT_PATH" junit-implants-macOS-latest.xml
        else
          echo "No JUnit report generated"
        fi
        if [ -f junit-implants-macOS-latest.xml ]; then
          npx junit-to-ctrf junit-implants-macOS-latest.xml -o ctrf-implants-macOS-latest.json
        fi
    - name: ðŸ“¶ Upload Coverage Results
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./implants/lcov.info
        flags: implants
        name: implants-coverage-macOS-latest
    - name: ðŸ“¤ Upload CTRF Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ctrf-implants-macOS-latest
        path: implants/ctrf-implants-macOS-latest.json

  ####################################################################################
  ###                     IMPLANTS - WINDOWS (Build on Linux)                      ###
  ####################################################################################
  implants-build-windows:
    name: Implants Build (Windows cross-compile)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      IMIX_SERVER_PUBKEY: "pR56vDJZb9b3BL3ZvCXIvgK0r2vCk7FiZ1RjeEhJVyU="
    steps:
    - uses: actions/checkout@v5
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: '1.91.1'
        components: rustfmt, clippy
        targets: x86_64-pc-windows-msvc
    - name: Setup Rust (Loader)
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: 'nightly-2025-11-27'
        components: rust-src, rustfmt
        targets: x86_64-pc-windows-gnu
    - name: Install mingw-w64
      run: |
        sudo apt update
        sudo apt install -y gcc-mingw-w64
    - name: rust-cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "./implants/ -> ../target"
        shared-key: windows-cross-compile
    - name: Build reflective loader
      shell: bash
      run: |
        cd ./bin/reflective_loader/
        cargo +nightly-2025-11-27 build --release --target=x86_64-pc-windows-gnu -Z build-std=core,compiler_builtins -Z build-std-features=compiler-builtins-mem
    - name: Install latest nextest and cargo-xwin release
      uses: taiki-e/install-action@v2
      with:
        tool: nextest,cargo-xwin
    - name: ðŸ”¨ Build tests (cross-compile for Windows)
      run: |
        cd ./implants/
        cargo fmt --check
        cargo xwin test --no-run --target=x86_64-pc-windows-msvc
    - name: ðŸ“¦ Create nextest archive
      run: |
        cd ./implants/
        cargo nextest archive --target=x86_64-pc-windows-msvc --archive-file nextest-archive-windows.tar.zst
    - name: ðŸ“¤ Upload test archive
      uses: actions/upload-artifact@v4
      with:
        name: nextest-archive-windows
        path: implants/nextest-archive-windows.tar.zst
        retention-days: 1

  ####################################################################################
  ###                     IMPLANTS - WINDOWS (Test on Windows)                     ###
  ####################################################################################
  implants-test-windows:
    name: Implants Test (Windows)
    runs-on: windows-latest
    needs: implants-build-windows
    timeout-minutes: 60
    env:
      IMIX_SERVER_PUBKEY: "pR56vDJZb9b3BL3ZvCXIvgK0r2vCk7FiZ1RjeEhJVyU="
    steps:
    - uses: actions/checkout@v5
    - name: ðŸ‘¾ Disable defender
      run: start-process -filepath powershell -ArgumentList '/c','Set-MpPreference -DisableRealtimeMonitoring $true' -verb RunAs
      shell: powershell
    - name: Install latest nextest release
      uses: taiki-e/install-action@v2
      with:
        tool: nextest
    - name: ðŸ“¥ Download test archive
      uses: actions/download-artifact@v4
      with:
        name: nextest-archive-windows
        path: implants/
    - name: ðŸ”Ž Run tests from archive
      shell: bash
      run: |
        cd ./implants/
        cargo nextest run --archive-file nextest-archive-windows.tar.zst
    - name: ðŸ”„ Convert to CTRF
      if: always()
      shell: bash
      run: |
        cd ./implants/
        JUNIT_PATH=$(find . -name junit.xml | head -n 1)
        if [ -n "$JUNIT_PATH" ]; then
          mv "$JUNIT_PATH" junit-implants-windows-latest.xml
        else
          echo "No JUnit report generated"
        fi
        if [ -f junit-implants-windows-latest.xml ]; then
          npx junit-to-ctrf junit-implants-windows-latest.xml -o ctrf-implants-windows-latest.json
        fi
    - name: ðŸ“¤ Upload CTRF Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ctrf-implants-windows-latest
        path: implants/ctrf-implants-windows-latest.json

  ui-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
    defaults:
      run:
        working-directory: tavern/internal/www
    steps:
    - uses: actions/checkout@v5
    - name: âš¡ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: tavern/internal/www/package-lock.json
    - name: ðŸ“¦ Install dependencies
      run: npm ci
    - name: ðŸ”Ž Run vitest with coverage
      # Generate JUnit XML
      run: npm test -- --run --coverage --reporter=junit --output-file=junit-ui-${{ matrix.os }}.xml
    - name: ðŸ”„ Convert to CTRF
      if: always()
      run: npx junit-to-ctrf junit-ui-${{ matrix.os }}.xml -o ctrf-ui-${{ matrix.os }}.json
    - name: ðŸ“¶ Upload Coverage Results
      if: always()
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./tavern/internal/www/coverage/lcov.info
        flags: ui-tests
        name: ui-tests-coverage
    - name: ðŸ“¤ Upload CTRF Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ctrf-ui-${{ matrix.os }}
        path: tavern/internal/www/ctrf-ui-${{ matrix.os }}.json
