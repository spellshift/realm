name: Tests

on:
  workflow_dispatch: ~
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  tavern:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: âš¡ Setup Golang
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache: true
    - name: ðŸ”¨ Install gotestsum
      run: go install gotest.tools/gotestsum@latest
    - name: ðŸ”¨ Build
      run: go build -v -o ./build/tavern ./tavern
    - name: ðŸ”Ž Test
      run: |
        gotestsum --junitfile junit-tavern-${{ matrix.os }}.xml -- \
          -v -race -coverprofile='coverage.out' -covermode=atomic ./tavern/...
    - name: ðŸ“¶ Upload Coverage Results
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.out
        flags: tavern
        name: tavern-coverage
    - name: ðŸ“¤ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-tavern-${{ matrix.os }}
        path: junit-tavern-${{ matrix.os }}.xml

  implants:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    env:
      IMIX_SERVER_PUBKEY: "pR56vDJZb9b3BL3ZvCXIvgK0r2vCk7FiZ1RjeEhJVyU="
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - macOS-latest
          - windows-latest
    steps:
    - uses: actions/checkout@v4
    - if: matrix.os == 'windows-latest'
      run: start-process -filepath powershell -ArgumentList '/c','Set-MpPreference -DisableRealtimeMonitoring $true' -verb RunAs
      name: ðŸ‘¾ Disable defender
      shell: powershell
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: '1.91.1'
        default: true
        profile: minimal
        components: rustfmt, clippy
    - name: Setup Rust (Loader)
      uses: dtolnay/rust-toolchain@master
      if: matrix.os == 'windows-latest'
      with:
        toolchain: 'nightly-2025-11-27'
        default: false
        profile: minimal
        components: rust-src, rustfmt
    - name: rust-cache
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: "./implants/ -> ../target"
    - if: matrix.os == 'windows-latest'
      shell: powershell
      name: Build reflective loader
      run: |
        cd ./bin/reflective_loader/
        cargo +nightly-2025-11-27 build --release -Z build-std=core,compiler_builtins -Z build-std-features=compiler-builtins-mem
    - name: Install latest nextest & cargo-llvm-cov release
      uses: taiki-e/install-action@v2
      with:
        tool: nextest,cargo-llvm-cov
    - name: ðŸ”Ž Run tests
      # Note: --junit-path must be before -- if passed to nextest, but usually nextest args are consumed by nextest directly.
      # However, cargo-llvm-cov passes extra args to nextest.
      # We put it directly after 'nextest' subcommand.
      run: |
        cd ./implants/ &&
        cargo fmt --check &&
        cargo llvm-cov nextest --lcov --output-path lcov.info --junit-path junit-implants-${{ matrix.os }}.xml
    - name: ðŸ“¶ Upload Coverage Results
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./implants/lcov.info
        flags: implants
        name: implants-coverage-${{ matrix.os }}
    - name: ðŸ“¤ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-implants-${{ matrix.os }}
        path: implants/junit-implants-${{ matrix.os }}.xml

  ui-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - ubuntu-latest
    defaults:
      run:
        working-directory: tavern/internal/www
    steps:
    - uses: actions/checkout@v4
    - name: âš¡ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: tavern/internal/www/package-lock.json
    - name: ðŸ“¦ Install dependencies
      run: npm ci
    - name: ðŸ”Ž Run vitest with coverage
      run: npm test -- --run --coverage --reporter=junit --output-file=junit-ui-${{ matrix.os }}.xml
    - name: ðŸ“¶ Upload Coverage Results
      if: always()
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./tavern/internal/www/coverage/lcov.info
        flags: ui-tests
        name: ui-tests-coverage
    - name: ðŸ“¤ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-ui-${{ matrix.os }}
        path: tavern/internal/www/junit-ui-${{ matrix.os }}.xml

  flaky-monitor:
    needs: [tavern, implants, ui-tests]
    runs-on: ubuntu-latest
    permissions:
      contents: write # Needed to push to test-results branch
      pull-requests: write # Needed to comment on PRs
    if: always() # Run even if tests fail
    steps:
    - uses: actions/checkout@v4

    # 1. Download current run artifacts
    - name: ðŸ“¥ Download Current Test Results
      uses: actions/download-artifact@v4
      with:
        pattern: test-results-*
        path: current_results
        merge-multiple: true

    # 2. Checkout or create the test-results branch to access history
    - name: ðŸ“š Checkout History
      run: |
        git fetch origin test-results:test-results || true
        if git show-ref --verify --quiet refs/heads/test-results; then
          git clone --branch test-results --single-branch https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git test-history
        else
          echo "Branch test-results does not exist. Creating empty directory."
          mkdir test-history
          cd test-history
          git init
          git checkout -b test-results
          # Need to setup remote if we want to push later, but clone handles it better.
          # For init, we need to add remote.
          git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        fi
      # Using manual git commands instead of actions/checkout to handle "branch doesn't exist" gracefully without failing the job

    # 3. Organize data
    - name: ðŸ—ƒï¸ Organize Data
      run: |
        mkdir -p test-history/history/${{ github.run_id }}
        cp current_results/*.xml test-history/history/${{ github.run_id }}/

        # Ensure we have the script available (it was checked out in step 1 from main)
        cp scripts/analyze_flaky_tests.py .

    # 4. Analyze
    - name: ðŸ“Š Analyze Test Results
      run: |
        # Analyze the entire history folder
        python3 analyze_flaky_tests.py test-history/history --output flaky-report.md
        cat flaky-report.md >> $GITHUB_STEP_SUMMARY

    # 5. Comment PR using github-script
    - name: ðŸ’¬ Comment PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('flaky-report.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          })

    # 6. Push updated history back to test-results branch
    - name: ðŸ’¾ Save History
      if: github.ref == 'refs/heads/main' # Only push history on main branch builds
      working-directory: test-history
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "Add test results for run ${{ github.run_id }}"
        git push origin test-results
