# Imix Build Configuration Example
#
# All fields are optional. If not specified, the build process will use:
# 1. Individual environment variables (e.g., IMIX_CALLBACK_URI)
# 2. Default values
#
# Usage (container-friendly pattern):
#   Set IMIX_BUILD_CONFIG environment variable with the YAML content:
#
#   export IMIX_BUILD_CONFIG="$(cat imix_config.yaml.example)"
#   cargo build --release
#
# Or inline:
#   export IMIX_BUILD_CONFIG='
#   callback_uri: "http://tavern.example.com:8000"
#   callback_interval: 10
#   '
#   cargo build --release
#
# In Dockerfile:
#   ENV IMIX_BUILD_CONFIG="callback_uri: http://tavern.example.com:8000\ncallback_interval: 10"
#
# In docker-compose.yml:
#   environment:
#     IMIX_BUILD_CONFIG: |
#       callback_uri: "http://tavern.example.com:8000"
#       callback_interval: 10

# ============================================================================
# CALLBACKS CONFIGURATION
# ============================================================================
# You can specify callbacks in two formats:
#
# 1. NEW FORMAT (recommended): List of callbacks with individual settings
# 2. LEGACY FORMAT: Single callback with global interval/retry settings
#
# The new format takes precedence if both are specified.

# --- NEW FORMAT: Multiple Callbacks ---
# Each callback can have its own URI, interval, and retry_interval
callbacks:
  # Primary callback - DNS transport with custom intervals
  - uri: "dns://8.8.8.8:53?domain=c2.example.com&type=txt"
    interval: 10          # Check every 10 seconds
    retry_interval: 5     # Retry after 5 seconds on error

  # Secondary callback - HTTP fallback with different timing
  - uri: "http://tavern.example.com:8000"
    interval: 30          # Check every 30 seconds
    retry_interval: 15    # Retry after 15 seconds on error

  # Tertiary callback - HTTPS with longer intervals
  - uri: "https://backup.example.com:443"
    interval: 60          # Check every 60 seconds
    retry_interval: 30    # Retry after 30 seconds on error

# --- LEGACY FORMAT: Single Callback (for backward compatibility) ---
# Uncomment these and comment out the 'callbacks' section above to use legacy format
#
# callback_uri: "http://tavern.example.com:8000"
# callback_interval: 10
# retry_interval: 10

# ============================================================================
# SERVER CONFIGURATION
# ============================================================================

# The public key for the tavern server
# Obtain from server using: curl $IMIX_CALLBACK_URI/status | jq -r '.Pubkey'
# If not specified, the build will attempt to fetch it automatically
# Required when using redirectors
server_pubkey: "your-base64-encoded-server-public-key-here"

# ============================================================================
# NETWORK CONFIGURATION
# ============================================================================

# Override system settings for proxy URI over HTTP(S)
# Must specify a scheme (e.g., http://, https://)
# If not specified, system proxy settings will be used (Linux only)
proxy_uri: "http://proxy.example.com:8080"

# ============================================================================
# BEACON CONFIGURATION
# ============================================================================

# Manually specify the host ID for this beacon
# This supersedes the file on disk
# Useful for avoiding disk writes
# host_id: "custom-host-identifier"

# Imix will only do one callback and execution of queued tasks
# May want to pair with runtime environment variable IMIX_BEACON_ID
# Default: false
run_once: false

# ============================================================================
# FEATURE FLAGS
# ============================================================================

# Feature flags for conditional compilation
# Valid values:
#   - grpc: Default gRPC transport (included by default)
#   - http1: Use HTTP/1.1 instead of HTTP/2 (requires http redirector)
#   - dns: Use DNS transport (requires dns redirector)
#   - transport-grpc-doh: Enable DNS over HTTPS for gRPC transport
#   - win_service: Enable Windows service support
#
# Note: When using http1 or dns, you typically want to exclude grpc
# Example for DNS transport:
#   features:
#     - dns
#
# Example for HTTP/1.1 transport:
#   features:
#     - http1
#
# Example for gRPC with DNS over HTTPS:
#   features:
#     - grpc
#     - transport-grpc-doh
features:
  - grpc

# ============================================================================
# CONFIGURATION EXAMPLES
# ============================================================================

# --- Example 1: Simple single callback (legacy format) ---
# callbacks: null
# callback_uri: "http://tavern.example.com:8000"
# callback_interval: 10
# retry_interval: 5

# --- Example 2: Multiple HTTP/HTTPS callbacks with failover ---
# callbacks:
#   - uri: "https://primary.example.com:443"
#     interval: 15
#     retry_interval: 5
#   - uri: "https://backup1.example.com:443"
#     interval: 30
#     retry_interval: 10
#   - uri: "https://backup2.example.com:443"
#     interval: 60
#     retry_interval: 20

# --- Example 3: DNS-only callbacks with different record types ---
# callbacks:
#   - uri: "dns://8.8.8.8:53?domain=c2.example.com&type=txt"
#     interval: 20
#     retry_interval: 10
#   - uri: "dns://1.1.1.1:53?domain=c2.example.com&type=a"
#     interval: 30
#     retry_interval: 15

# --- Example 4: Mixed transport (DNS primary, HTTP fallback) ---
# callbacks:
#   - uri: "dns://*?domain=c2.example.com"
#     interval: 10
#     retry_interval: 5
#   - uri: "http://fallback.example.com:8000"
#     interval: 60
#     retry_interval: 30

# --- Example 5: Single callback with optional intervals ---
# Intervals will use defaults if not specified
# callbacks:
#   - uri: "http://tavern.example.com:8000"

# DNS Transport URI Format Reference:
# dns://<server>?domain=<DOMAIN>[&type=<TYPE>]
#
# Parameters:
#   - server: DNS server address (e.g., 8.8.8.8:53) or * for system resolver
#   - domain: Base domain for DNS queries (e.g., c2.example.com)
#   - type: DNS record type - txt (default), a, or aaaa
#
# Examples:
#   - dns://8.8.8.8:53?domain=c2.example.com (TXT records via Google DNS)
#   - dns://*?domain=c2.example.com (System resolver with fallback)
#   - dns://8.8.8.8:53,1.1.1.1:53?domain=c2.example.com&type=a (Multiple servers, A records)
#   - dns://8.8.8.8:53?domain=c2.example.com&type=aaaa (AAAA records)
