# Imix Build Configuration Example
#
# All fields are optional. If not specified, the build process will use:
# 1. Individual environment variables (e.g., IMIX_CALLBACK_URI)
# 2. Default values
#
# Usage (container-friendly pattern):
#   Set IMIX_BUILD_CONFIG environment variable with the YAML content:
#
#   export IMIX_BUILD_CONFIG="$(cat imix_config.yaml.example)"
#   cargo build --release
#
# Or inline:
#   export IMIX_BUILD_CONFIG='
#   callback_uri: "http://tavern.example.com:8000"
#   callback_interval: 10
#   '
#   cargo build --release
#
# In Dockerfile:
#   ENV IMIX_BUILD_CONFIG="callback_uri: http://tavern.example.com:8000\ncallback_interval: 10"
#
# In docker-compose.yml:
#   environment:
#     IMIX_BUILD_CONFIG: |
#       callback_uri: "http://tavern.example.com:8000"
#       callback_interval: 10

# ============================================================================
# CALLBACKS CONFIGURATION
# ============================================================================
# Callbacks are specified as a list of callback configurations.
# Each callback can have its own URI, interval, retry_interval, and proxy_uri.

# Multiple Callbacks with individual settings
callbacks:
  # Primary callback - DNS transport with custom intervals
  - uri: "dns://8.8.8.8:53?domain=c2.example.com&type=txt"
    interval: 10          # Check every 10 seconds
    retry_interval: 5     # Retry after 5 seconds on error

  # Secondary callback - HTTP/1.1 fallback with different timing and proxy
  - uri: "http://tavern.example.com:8000"
    interval: 30          # Check every 30 seconds
    retry_interval: 15    # Retry after 15 seconds on error
    proxy_uri: "http://proxy.example.com:8080"  # Optional: HTTP(S) proxy (http1/grpc only)

  # Tertiary callback - HTTPS with longer intervals and DoH
  - uri: "https://backup.example.com:443"
    interval: 60          # Check every 60 seconds
    retry_interval: 30    # Retry after 30 seconds on error
    doh_provider: "cloudflare"  # Optional: Use DNS-over-HTTPS for gRPC (cloudflare/google/quad9)

# ============================================================================
# SERVER CONFIGURATION
# ============================================================================

# The public key for the tavern server
# This is the first HTTPS callback URI in the callbacks list
# Obtain from server using: curl https://your-server/status | jq -r '.Pubkey'
# If not specified, the build will attempt to fetch it automatically
# Required when using redirectors
server_pubkey: "your-base64-encoded-server-public-key-here"

# ============================================================================
# BEACON CONFIGURATION
# ============================================================================

# Manually specify the host ID for this beacon
# This supersedes the file on disk
# Useful for avoiding disk writes
# host_id: "custom-host-identifier"

# Imix will only do one callback and execution of queued tasks
# May want to pair with runtime environment variable IMIX_BEACON_ID
# Default: false
run_once: false

# ============================================================================
# FEATURE FLAGS
# ============================================================================

# Feature flags for conditional compilation
# Valid values:
#   - grpc: Default gRPC transport
#   - http1: Use HTTP/1.1 instead of HTTP/2 (requires http redirector)
#   - dns: Use DNS transport (requires dns redirector)
#   - win_service: Enable Windows service support
#
# Note: DNS-over-HTTPS for gRPC is now configured per-callback via doh_provider field
#
# By default, all transports are included for maximum flexibility
# You can customize this list to include only the transports you need
features:
  - grpc
  - http1
  - dns

# ============================================================================
# CONFIGURATION EXAMPLES
# ============================================================================

# --- Example 1: Simple single callback ---
# callbacks:
#   - uri: "http://tavern.example.com:8000"
#     interval: 10
#     retry_interval: 5

# --- Example 2: Multiple HTTP/HTTPS callbacks with failover and proxies ---
# callbacks:
#   - uri: "https://primary.example.com:443"
#     interval: 15
#     retry_interval: 5
#     proxy_uri: "http://proxy1.example.com:8080"
#   - uri: "https://backup1.example.com:443"
#     interval: 30
#     retry_interval: 10
#     proxy_uri: "http://proxy2.example.com:8080"
#   - uri: "https://backup2.example.com:443"
#     interval: 60
#     retry_interval: 20

# --- Example 3: DNS-only callbacks with different record types ---
# callbacks:
#   - uri: "dns://8.8.8.8:53?domain=c2.example.com&type=txt"
#     interval: 20
#     retry_interval: 10
#   - uri: "dns://1.1.1.1:53?domain=c2.example.com&type=a"
#     interval: 30
#     retry_interval: 15

# --- Example 4: Mixed transport (DNS primary, HTTP fallback) ---
# callbacks:
#   - uri: "dns://*?domain=c2.example.com"
#     interval: 10
#     retry_interval: 5
#   - uri: "http://fallback.example.com:8000"
#     interval: 60
#     retry_interval: 30
#     proxy_uri: "http://proxy.example.com:8080"

# --- Example 5: Single callback with optional intervals ---
# Intervals will use defaults if not specified
# callbacks:
#   - uri: "http://tavern.example.com:8000"

# DNS Transport URI Format Reference:
# dns://<server>?domain=<DOMAIN>[&type=<TYPE>]
#
# Parameters:
#   - server: DNS server address (e.g., 8.8.8.8:53) or * for system resolver
#   - domain: Base domain for DNS queries (e.g., c2.example.com)
#   - type: DNS record type - txt (default), a, or aaaa
#
# Examples:
#   - dns://8.8.8.8:53?domain=c2.example.com (TXT records via Google DNS)
#   - dns://*?domain=c2.example.com (System resolver with fallback)
#   - dns://8.8.8.8:53,1.1.1.1:53?domain=c2.example.com&type=a (Multiple servers, A records)
#   - dns://8.8.8.8:53?domain=c2.example.com&type=aaaa (AAAA records)
