const fs = require('fs');
const path = require('path');

// Determine paths
const SCRIPT_DIR = __dirname;
// scripts -> mcp-server -> vscode-tome-builder -> vscode -> root
const REPO_ROOT = path.resolve(SCRIPT_DIR, '../../../../');
const DOCS_DIR = path.join(REPO_ROOT, 'docs/_docs/user-guide');
const TOMES_DIR = path.join(REPO_ROOT, 'tavern/tomes');
const OUT_FILE = path.join(SCRIPT_DIR, '../src/assets.ts');

console.log(`Building assets from ${REPO_ROOT}...`);

// 1. Read Docs
const docs = {};
try {
    docs.tomes = fs.readFileSync(path.join(DOCS_DIR, 'tomes.md'), 'utf-8');
    docs.eldritch = fs.readFileSync(path.join(DOCS_DIR, 'eldritch.md'), 'utf-8');
    console.log('Docs loaded.');
} catch (e) {
    console.error('Error reading docs:', e);
    process.exit(1);
}

// 2. Read Tome Examples
const examples = {};
try {
    const entries = fs.readdirSync(TOMES_DIR, { withFileTypes: true });
    for (const entry of entries) {
        if (entry.isDirectory()) {
            const tomePath = path.join(TOMES_DIR, entry.name);
            const metadataPath = path.join(tomePath, 'metadata.yml');
            const scriptPath = path.join(tomePath, 'main.eldritch');

            if (fs.existsSync(metadataPath) && fs.existsSync(scriptPath)) {
                examples[entry.name] = {
                    metadata: fs.readFileSync(metadataPath, 'utf-8'),
                    script: fs.readFileSync(scriptPath, 'utf-8')
                };
            }
        }
    }
    console.log(`Loaded ${Object.keys(examples).length} examples.`);
} catch (e) {
    console.error('Error reading examples:', e);
    process.exit(1);
}

// 3. Generate TypeScript File
const content = `// This file is auto-generated by scripts/bundle-assets.js
// Do not edit this file directly.

export const DOCS: Record<string, string> = ${JSON.stringify(docs, null, 4)};

export interface TomeExample {
    metadata: string;
    script: string;
}

export const EXAMPLES: Record<string, TomeExample> = ${JSON.stringify(examples, null, 4)};
`;

fs.writeFileSync(OUT_FILE, content);
console.log(`Assets written to ${OUT_FILE}`);
